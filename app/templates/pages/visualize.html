{% extends "partials/base.html" %}

{% block content %}
<div class="container my-5">
    <h2 class="mb-4"><i class="bi bi-globe"></i> Visualisation 3D du Nuage de Points</h2>

    <select id="fileSelector" class="form-control mb-3">
        <option value="">-- Choisir un fichier --</option>
        {% for file in files %}
            <option value="{{ file }}">{{ file }}</option>
        {% endfor %}
    </select>

    <div id="viewer" style="width: 100%; height: 500px; background: #222;"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.min.js"></script>

<script>
    let scene, camera, renderer, cloud, controls;
    
    document.addEventListener("DOMContentLoaded", () => {
        initViewer();
    
        const selector = document.getElementById("fileSelector");
        selector.addEventListener("change", () => {
            const filename = selector.value;
            if (!filename) return;
    
            fetch(`/api/points/${filename}`)
                .then(res => res.json())
                .then(data => {
                    const points = data.map(p => new THREE.Vector3(p[0], p[1], p[2]));
                    updatePointCloud(points);
                    console.log("Points chargÃ©s :", points.length);
                })
                .catch(err => console.error("Erreur API :", err));
        });
    });
    
    function initViewer() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x222222);
    
        camera = new THREE.PerspectiveCamera(75, window.innerWidth / 500, 0.1, 1000);
        camera.position.set(0, 0, 5);
    
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, 500);
        document.getElementById("viewer").appendChild(renderer.domElement);
    
        controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
    
        const light = new THREE.PointLight(0xffffff, 1);
        light.position.set(10, 10, 10);
        scene.add(light);
    
        animate();
    }
    
    function updatePointCloud(points) {
        if (cloud) scene.remove(cloud);
        const geometry = new THREE.BufferGeometry().setFromPoints(points);
        const material = new THREE.PointsMaterial({ color: 0x00ff00, size: 0.05 });
        cloud = new THREE.Points(geometry, material);
        scene.add(cloud);
    }
    
    function animate() {
        requestAnimationFrame(animate);
        controls.update();
        renderer.render(scene, camera);
    }
    </script>
    {% endblock %}