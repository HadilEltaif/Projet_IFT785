{% extends "partials/base.html" %}

{% block content %}
<div class="container my-5">
    <h2 class="mb-4"><i class="bi bi-globe"></i> Visualisation 3D du Nuage de Points</h2>
    <input type="text" id="fileName" class="form-control mb-3" readonly value="{{ filename }}">
    <div id="viewer" style="width: 100%; height: 500px; background: #222;"></div>
</div>

<!-- Three.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/three@0.157.0/build/three.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const filename = "{{ filename }}";
    if (!filename) return;

    fetch(`/uploads/${filename}`)
        .then(response => {
            if (!response.ok) throw new Error("Fichier introuvable !");
            return response.text();
        })
        .then(data => {
            const points = parsePCD(data);
            console.log("Points chargés :", points.length);
            console.log("Contenu brut PCD :", data.split('\n').slice(0, 15));

            initViewer(points);
        })
        .catch(error => {
            console.error("Erreur de chargement ou parsing :", error);
        });

    function parsePCD(content) {
        const lines = content.split('\n');
        const dataStart = lines.findIndex(line => line.toLowerCase().startsWith('data')) + 1;
        const points = [];

        for (let i = dataStart; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;
            const values = line.split(' ').map(parseFloat);
            if (values.length >= 3 && values.every(val => !isNaN(val))) {
                const [x, y, z] = values;
                points.push(new THREE.Vector3(x, y, z));
            }
        }
        return points;
    }

    function initViewer(points) {
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x222222);

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / 500, 0.1, 1000);
        camera.position.z = 5;

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, 500);
        document.getElementById("viewer").appendChild(renderer.domElement);

        const geometry = new THREE.BufferGeometry().setFromPoints(points);
        const material = new THREE.PointsMaterial({ color: 0x00ff00, size: 0.05 });
        const cloud = new THREE.Points(geometry, material);
        scene.add(cloud);

        // Ajouter une lumière
        const light = new THREE.PointLight(0xffffff, 1);
        light.position.set(10, 10, 10);
        scene.add(light);

        const animate = function () {
            requestAnimationFrame(animate);
            cloud.rotation.y += 0.001;
            renderer.render(scene, camera);
        };
        animate();
    }
});
</script>
{% endblock %}
