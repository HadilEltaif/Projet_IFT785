{% extends "partials/base.html" %}

{% block content %}
<div class="container my-5">
    <h2 class="mb-4"><i class="bi bi-globe"></i> Visualisation 3D du Nuage de Points</h2>

    <select id="fileSelector" class="form-control mb-3">
        <option value="">-- Choisir un fichier --</option>
        {% for file in files %}
            <option value="{{ file }}" {% if file == filename %}selected{% endif %}>{{ file }}</option>
        {% endfor %}
    </select>

    <p id="pointCount" class="mt-2">Nombre de points : ...</p>

    <div id="viewer" style="width: 100%; height: 500px; background: #222;"></div>
</div>

<!-- 📦 Three.js + OrbitControls -->
<script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.min.js"></script>

<!-- 🎛️ dat.GUI -->
<script src="https://cdn.jsdelivr.net/npm/dat.gui/build/dat.gui.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const selector = document.getElementById('fileSelector');
    const viewer = document.getElementById('viewer');

    // ⏩ Rediriger vers ?filename=
    selector.addEventListener('change', () => {
        const file = selector.value;
        if (file) {
            window.location.href = `/visualize?filename=${file}`;
        }
    });

    const filename = "{{ filename }}";
    if (!filename) return;

    fetch(`/api/points/${filename}`)
        .then(response => response.json())
        .then(data => {
            const points = data.map(p => new THREE.Vector3(p[0], p[1], p[2]));
            document.getElementById("pointCount").textContent = `Nombre de points : ${points.length}`;
            initViewer(points);
        })
        .catch(error => console.error("Erreur API :", error));

    function initViewer(points) {
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x222222);

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / 500, 0.1, 1000);
        camera.position.set(0, 0, 5);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, 500);
        viewer.innerHTML = "";
        viewer.appendChild(renderer.domElement);

        const geometry = new THREE.BufferGeometry().setFromPoints(points);
        const material = new THREE.PointsMaterial({ color: 0x00ff00, size: 0.05 });
        const cloud = new THREE.Points(geometry, material);
        scene.add(cloud);

        // 🌀 Contrôles
        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;

        // 🔀 Aides
        const axesHelper = new THREE.AxesHelper(1);
        scene.add(axesHelper);

        const gridHelper = new THREE.GridHelper(10, 10);
        scene.add(gridHelper);

        // 💡 Lumière
        const light = new THREE.PointLight(0xffffff, 1);
        light.position.set(10, 10, 10);
        scene.add(light);

        // 🎛️ GUI
        const gui = new dat.GUI();
        const params = {
            resetCamera: () => {
                camera.position.set(0, 0, 5);
                controls.target.set(0, 0, 0);
                controls.update();
            },
            pointSize: 0.05,
            color: "#00ff00",
            bgColor: "#222222",
            showAxes: true,
            showGrid: true,
            capture: () => {
                const imgData = renderer.domElement.toDataURL("image/png");
                const link = document.createElement("a");
                link.download = "nuage_capture.png";
                link.href = imgData;
                link.click();
            },
            saveCamera: () => {
                localStorage.setItem("cameraPos", JSON.stringify(camera.position));
                alert("📸 Position de la caméra sauvegardée.");
            },
            loadCamera: () => {
                const pos = JSON.parse(localStorage.getItem("cameraPos"));
                if (pos) {
                    camera.position.set(pos.x, pos.y, pos.z);
                    controls.update();
                }
            }
        };

        gui.add(params, 'resetCamera').name("🔁 Réinitialiser la caméra");
        gui.add(params, 'pointSize', 0.01, 0.2).onChange(v => cloud.material.size = v);
        gui.addColor(params, 'color').onChange(c => cloud.material.color.set(c));
        gui.addColor(params, 'bgColor').onChange(c => scene.background.set(c));
        gui.add(params, 'showAxes').onChange(v => axesHelper.visible = v);
        gui.add(params, 'showGrid').onChange(v => gridHelper.visible = v);

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        animate();
    }
});
</script>
{% endblock %}
